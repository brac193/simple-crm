<% content_for :title, "Car Returns Management" %>

<div class="card mb-6">
  <h1 class="card-title mb-6">Car Returns Management</h1>
</div>

<div class="card mb-6">
  <h2 class="card-title mb-4">
    <i class="fas fa-exclamation-triangle" style="color: #e74c3c; margin-right: 0.5rem;"></i>
    Overdue Returns (<%= @overdue_reservations.count %>)
  </h2>
  
  <% if @overdue_reservations.any? %>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Customer</th>
            <th>Car</th>
            <th>End Date</th>
            <th>Days Overdue</th>
            <th>Penalty Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @overdue_reservations.each do |reservation| %>
            <tr style="background-color: #fef2f2;">
              <td>
                <strong><%= reservation.user.full_name %></strong><br>
                <small style="color: #6b7280;"><%= reservation.user.email %></small>
              </td>
              <td>
                <strong><%= reservation.car.display_name %></strong><br>
                <small style="color: #6b7280;"><%= reservation.car.license_plate %></small>
              </td>
              <td>
                <%= reservation.end_date.strftime("%b %d, %Y") %><br>
                <small style="color: #e74c3c;"><%= time_ago_in_words(reservation.end_date) %> ago</small>
              </td>
              <td>
                <span style="color: #e74c3c; font-weight: 600;">
                  <%= reservation.days_overdue %> days
                </span>
              </td>
              <td>
                <strong style="color: #e74c3c;">
                  <%= number_to_currency(reservation.calculate_penalty_amount) %>
                </strong>
              </td>
              <td>
                <%= form_with url: mark_returned_admin_return_path(reservation), method: :patch, local: true do |form| %>
                  <%= form.submit "Mark Returned", 
                      class: "btn btn-sm btn-success",
                      data: { confirm: "Mark this car as returned? This will generate an invoice with penalty fees." } %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="text-center" style="padding: 2rem;">
      <i class="fas fa-check-circle" style="font-size: 3rem; color: #27ae60; margin-bottom: 1rem;"></i>
      <p style="color: #6b7280;">No overdue returns!</p>
    </div>
  <% end %>
</div>

<div class="card">
  <h2 class="card-title mb-4">
    <i class="fas fa-clock" style="color: #f39c12; margin-right: 0.5rem;"></i>
    Recently Ended Reservations
  </h2>
  
  <% if @recently_ended.any? %>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Customer</th>
            <th>Car</th>
            <th>End Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @recently_ended.each do |reservation| %>
            <tr>
              <td>
                <strong><%= reservation.user.full_name %></strong><br>
                <small style="color: #6b7280;"><%= reservation.user.email %></small>
              </td>
              <td>
                <strong><%= reservation.car.display_name %></strong><br>
                <small style="color: #6b7280;"><%= reservation.car.license_plate %></small>
              </td>
              <td>
                <%= reservation.end_date.strftime("%b %d, %Y") %><br>
                <small style="color: #6b7280;"><%= time_ago_in_words(reservation.end_date) %> ago</small>
              </td>
              <td>
                <% if reservation.is_overdue? %>
                  <span class="status-badge active" style="background-color: #e74c3c;">Overdue</span>
                <% else %>
                  <span class="status-badge completed">Ended</span>
                <% end %>
              </td>
              <td>
                <%= form_with url: mark_returned_admin_return_path(reservation), method: :patch, local: true do |form| %>
                  <%= form.submit "Mark Returned", 
                      class: "btn btn-sm btn-primary",
                      data: { confirm: "Mark this car as returned? This will generate an invoice." } %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="text-center" style="padding: 2rem;">
      <i class="fas fa-calendar-check" style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;"></i>
      <p style="color: #6b7280;">No recently ended reservations.</p>
    </div>
  <% end %>
</div>

<div class="card mt-6">
  <h2 class="card-title mb-4">
    <i class="fas fa-car" style="color: #27ae60; margin-right: 0.5rem;"></i>
    Active Reservations (Early Returns)
  </h2>
  
  <% active_reservations = Reservation.current.includes(:user, :car).order(start_date: :asc) %>
  <% if active_reservations.any? %>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Customer</th>
            <th>Car</th>
            <th>Rental Period</th>
            <th>Days Remaining</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% active_reservations.each do |reservation| %>
            <tr>
              <td>
                <strong><%= reservation.user.full_name %></strong><br>
                <small style="color: #6b7280;"><%= reservation.user.email %></small>
              </td>
              <td>
                <strong><%= reservation.car.display_name %></strong><br>
                <small style="color: #6b7280;"><%= reservation.car.license_plate %></small>
              </td>
              <td>
                <%= reservation.start_date.strftime("%b %d") %> - <%= reservation.end_date.strftime("%b %d, %Y") %><br>
                <small style="color: #6b7280;"><%= pluralize(reservation.duration_days, 'day') %> total</small>
              </td>
              <td>
                <% days_remaining = (reservation.end_date - Date.current).to_i %>
                <span style="color: #27ae60; font-weight: 600;">
                  <%= pluralize(days_remaining, 'day') %>
                </span>
              </td>
              <td>
                <%= form_with url: mark_returned_admin_return_path(reservation), method: :patch, local: true do |form| %>
                  <%= form.submit "Early Return", 
                      class: "btn btn-sm btn-warning",
                      data: { confirm: "Return this car early? The invoice will be recalculated based on actual rental days." } %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="text-center" style="padding: 2rem;">
      <i class="fas fa-car" style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;"></i>
      <p style="color: #6b7280;">No active reservations.</p>
    </div>
  <% end %>
</div>

<div class="mt-4">
  <%= link_to admin_path, class: "btn btn-secondary" do %>
    <i class="fas fa-arrow-left" style="margin-right: 0.5rem;"></i>Back to Dashboard
  <% end %>
  <%= link_to admin_invoices_path, class: "btn btn-primary" do %>
    <i class="fas fa-file-invoice" style="margin-right: 0.5rem;"></i>View Invoices
  <% end %>
</div>
